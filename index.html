<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Indent â€” ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</title>
  <style>
    body { 
      font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif; 
      margin: 0; 
      background: #f5f7fa;
      color: #333; 
      min-height: 100vh;
    }
    header { 
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 12px; 
      background: #fff;
      border-bottom: 1px solid #e1e8ed;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      position: sticky; top: 0; z-index: 10;
    }
    h1 { 
      font-size: 16px; 
      margin: 0; 
      color: #2c3e50;
      font-weight: 600;
    }
    h2 {
      color: #2c3e50;
      font-size: 15px;
      margin-bottom: 10px;
      font-weight: 600;
    }
    main { 
      padding: 10px; 
      padding-bottom: 65px;
    }
    button, input, select, textarea { 
      font-size: 14px; 
      padding: 10px 12px; 
      border: 1px solid #d1dbe3; 
      border-radius: 5px; 
      box-sizing: border-box;
      transition: all 0.2s ease;
      font-family: inherit;
      min-height: 44px;
    }
    button { 
      background: #3498db;
      color: #fff; 
      cursor: pointer;
      font-weight: 500;
      border: none;
    }
    button:hover {
      background: #2980b9;
    }
    button:active {
      transform: scale(0.98);
    }
    input, select {
      background: #fff;
      border: 1px solid #d1dbe3;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
    }

    /* â–¼ ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    nav { 
      position: fixed; bottom: 0; left: 0; right: 0; display: flex; 
      background: #fff;
      border-top: 1px solid #e1e8ed;
      z-index: 20;
      box-shadow: 0 -1px 3px rgba(0,0,0,0.05);
    }
    nav button { 
      flex: 1; 
      border: none; 
      border-right: 1px solid #e1e8ed;
      background: #fff;
      color: #657786; 
      padding: 12px 5px;
      font-size: 12px;
      font-weight: 500;
      line-height: 1.3;
      min-height: 48px;
    }
    nav button.active { 
      background: #f0f8ff;
      color: #3498db;
      font-weight: 600;
    }
    nav button:hover {
      background: #f9fafb;
    }
    nav button:last-child { border-right: none; }

    .hidden { display: none; }

    /* â–¼ å„ãƒªã‚¹ãƒˆè¡Œ */
    .list-item {
      background: #fff;
      border: 1px solid #e1e8ed;
      padding: 8px 10px;
      margin-bottom: 6px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }
    .list-item:hover {
      border-color: #3498db;
      box-shadow: 0 1px 4px rgba(52, 152, 219, 0.1);
    }

    .item-left {
      display: flex;
      flex-direction: column;
      font-size: 14px;
      flex: 1;
      color: #2c3e50;
      min-width: 0;
      gap: 4px;
    }

    /* â–¼ å°ãƒœã‚¿ãƒ³ */
    .small-btn {
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 5px;
      background: #27ae60;
      color: #fff;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      min-width: 60px;
      min-height: 40px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .small-btn:hover { 
      background: #229954;
    }

    /* â–¼ å…¥åŠ›ã‚µã‚¤ã‚ºèª¿æ•´ */
    .item-left div {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 4px;
    }
    .small-input { 
      font-size: 13px; 
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #d1dbe3;
    }
    .small-input.qty { width: 65px; }
    .small-input.memo { width: 100px; flex: 1; }
    .memo, .qty { font-size: 12px; color: #657786; }

    /* â–¼ ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .group-header {
      background: #fff;
      border: 1px solid #e1e8ed;
      border-left: 3px solid #3498db;
      padding: 8px 10px;
      margin: 10px 0 6px 0;
      border-radius: 5px;
      font-weight: 600;
      font-size: 14px;
      color: #2c3e50;
    }

    .group-item {
      background: #fff;
      border: 1px solid #e1e8ed;
      padding: 8px 10px;
      margin-bottom: 6px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .group-color {
      width: 32px;
      height: 32px;
      border-radius: 5px;
      border: 2px solid #e1e8ed;
      flex-shrink: 0;
    }

    .small-select {
      font-size: 13px;
      padding: 5px 8px;
      border: 1px solid #d1dbe3;
      border-radius: 4px;
      background: #fff;
    }

    /* â–¼ ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ•°é‡æŒ‡å®šãƒœãƒƒã‚¯ã‚¹ */
    .inline-check-box {
      background: #fff9e6;
      border: 1px solid #f39c12;
      border-radius: 5px;
      padding: 10px;
      margin: 6px 0;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      font-size: 13px;
    }

    .inline-check-box input[type="number"] {
      width: 70px;
      font-size: 14px;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #d1dbe3;
      font-weight: 500;
    }

    .inline-check-box .small-btn {
      font-size: 12px;
      padding: 6px 10px;
    }

    .inline-check-box button.inline-close {
      font-size: 12px;
      padding: 5px 10px;
      background: #95a5a6;
    }

    .code-clickable {
      font-weight: 600;
      color: #3498db;
      cursor: pointer;
    }
    .code-clickable:hover {
      color: #2980b9;
      text-decoration: underline;
    }
    .copy-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
      min-height: auto;
      min-width: auto;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .copy-btn:hover {
      background: #f0f8ff;
      transform: scale(1.1);
    }
    .copy-btn:active {
      transform: scale(0.95);
    }
    .copy-btn.copied {
      color: #27ae60;
    }

    .code-with-copy {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .code-with-image {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}


    #langBtn {
      background: #ecf0f1;
      color: #2c3e50;
      border: 1px solid #d1dbe3;
      font-size: 12px;
      padding: 6px 10px;
      font-weight: 500;
    }
    #langBtn:hover {
      background: #dfe6e9;
    }

    #passwordError {
      color: #e74c3c;
      font-weight: 500;
      margin-top: 8px;
      font-size: 13px;
    }

    section {
      background: #fff;
      border-radius: 6px;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      margin-bottom: 8px;
    }

    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #3498db;
      flex-shrink: 0;
      min-width: 20px;
      min-height: 20px;
    }

    /* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸å°‚ç”¨ */
    #page-password input, #page-login input {
      display: block;
      width: 100%;
      margin: 0 0 10px 0;
    }
    #page-password button, #page-login button {
      display: block;
      width: 100%;
      margin: 0;
    }

    /* å…¥åŠ›æ¬„ã®ã‚³ãƒ³ãƒ†ãƒŠ */
    section > div {
      margin-bottom: 10px;
    }

    /* ã‚ˆã‚Šç‹­ã„ã‚¹ãƒšãƒ¼ã‚·ãƒ³ã‚° */
    .group-name-input {
      font-size: 13px;
      padding: 5px 8px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <header>
    <h1 id="title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›</h1>
    <div style="display:flex;gap:8px;align-items:center;">
      <span id="userDisplay" style="display:none;font-size:12px;color:#657786;"></span>
      <button id="logoutBtn" style="display:none;font-size:12px;padding:6px 10px;background:#e74c3c;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      <button id="langBtn">æ—¥æœ¬èª / English</button>
    </div>
  </header>

  <main>
    <!-- Password Page -->
    <section id="page-password">
      <input id="passwordInput" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" />
      <button id="passwordSubmit">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="passwordError" style="color:red;display:none">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</p>
    </section>

    <!-- Login Page -->
    <section id="page-login" class="hidden">
      <input id="userIdInput" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›" />
      <button id="loginSubmit">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </section>

    <!-- Pre-Check List Page -->
    <section id="page-precheck" class="hidden">
      <h2 id="precheckTitle">ãƒã‚§ãƒƒã‚¯å¾…ã¡ãƒªã‚¹ãƒˆ</h2>
      <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
        <!-- IKEAç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
<div id="ikeaImage" style="margin-top:10px; text-align:center;"></div>

        <input id="productCodeInput" placeholder="7æ¡ã®ã‚³ãƒ¼ãƒ‰" />
        <input id="productQtyInput" type="number" min="1" value="1" />
        <input id="productMemoInput" placeholder="ãƒ¡ãƒ¢" />
        <button id="addProductBtn">è¿½åŠ </button>
        <button id="ocrBtn">OCRè¿½åŠ </button>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;align-items:center;">
        <button id="selectAllBtn">å…¨é¸æŠ</button>
        <button id="deselectAllBtn">å…¨è§£é™¤</button>
        <select id="bulkGroupSelect" class="small-select">
          <option value="">ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠ</option>
        </select>
        <button id="bulkGroupBtn">é¸æŠä¸­ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–</button>
      </div>
      <div id="precheckList"></div>
      <button id="precheckConfirm">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã¸ç¢ºå®š</button>
      <button id="precheckReset">ãƒªã‚»ãƒƒãƒˆ</button>
    </section>

    <!-- Checklist Page -->
    <section id="page-checklist" class="hidden">
      <h2 id="checklistTitle">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h2>
      <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
        <input id="searchCodeInput" placeholder="ã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢" />
        <button id="searchBtn">æ¤œç´¢</button>
      </div>
      <div id="checklist"></div>
      <button id="checklistReset">ãƒªã‚»ãƒƒãƒˆ</button>
    </section>

    <!-- Checked List Page -->
    <section id="page-checked" class="hidden">
      <h2 id="checkedTitle">ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ãƒªã‚¹ãƒˆ</h2>
      <div id="checkedList"></div>
    </section>

    <!-- Groups Page -->
    <section id="page-groups" class="hidden">
      <h2 id="groupsTitle">ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</h2>
      <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
        <input id="groupNameInput" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å" />
        <input id="groupColorInput" type="color" value="#1976d2" />
        <button id="addGroupBtn">ã‚°ãƒ«ãƒ¼ãƒ—è¿½åŠ </button>
      </div>
      <div id="groupsList"></div>
    </section>
  </main>

  <nav>
    <button id="navPrecheck">ãƒã‚§ãƒƒã‚¯å‰ãƒªã‚¹ãƒˆ</button>
    <button id="navChecklist">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</button>
    <button id="navChecked">ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ä¸€è¦§</button>
    <button id="navGroups">ã‚°ãƒ«ãƒ¼ãƒ—</button>
  </nav>

  <script>
 // ğŸ”¹ Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyDhmLTaC6Sks7sNcDgjPm1my1GBOuS6L2M",
      authDomain: "biz-pick.firebaseapp.com",
      databaseURL: "https://biz-pick-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "biz-pick",
      storageBucket: "biz-pick.firebasestorage.app",
      messagingSenderId: "170876055783",
      appId: "1:170876055783:web:67a06678f0fec4fd3bb242",
      measurementId: "G-47G2K5PRSC"
    };
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    const PASSWORD = '0509';
    let lang = 'ja';
    // å…¨ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ç”¨ã®å¤‰æ•°
    let langBtnClickCount = 0;
    let langBtnClickTimer = null;

    const texts = {
      ja: {
        passwordTitle:'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›',
        passwordPlaceholder:'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›',
        loginBtn:'ãƒ­ã‚°ã‚¤ãƒ³',
        loginTitle:'ãƒ­ã‚°ã‚¤ãƒ³',
        userIdPlaceholder:'ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›',
        logoutBtn:'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
        currentUser:'ãƒ­ã‚°ã‚¤ãƒ³ä¸­:',
        precheckTitle:'ãƒã‚§ãƒƒã‚¯å¾…ã¡ãƒªã‚¹ãƒˆ', 
        checklistTitle:'ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ', 
        checkedTitle:'ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ãƒªã‚¹ãƒˆ',
        groupsTitle:'ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†',
        wrongPass:'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™', 
        add:'è¿½åŠ ', 
        ocr:'OCRè¿½åŠ ', 
        confirm:'ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã¸ç¢ºå®š', 
        reset:'ãƒªã‚»ãƒƒãƒˆ', 
        del:'å‰Šé™¤', 
        check:'âœ”',
        codePlaceholder:'8æ¡ã®ã‚³ãƒ¼ãƒ‰',
        qtyLabel:'æ•°é‡',
        memoPlaceholder:'ãƒ¡ãƒ¢',
        searchPlaceholder:'ã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢',
        searchBtn:'æ¤œç´¢',
        notFound:'ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
        navPrecheck:'ãƒã‚§ãƒƒã‚¯å‰ãƒªã‚¹ãƒˆ',
        navChecklist:'ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ',
        navChecked:'ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ä¸€è¦§',
        navGroups:'ã‚°ãƒ«ãƒ¼ãƒ—',
        alertId:'IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
        alertCode:'8æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
        confirmAdd:'ä»¶ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ',
        noCode:'ã‚³ãƒ¼ãƒ‰ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ',
        confirmReset:'æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ',
        confirmChecklistReset:'ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ',
        groupNamePlaceholder:'ã‚°ãƒ«ãƒ¼ãƒ—å',
        addGroup:'ã‚°ãƒ«ãƒ¼ãƒ—è¿½åŠ ',
        editGroup:'ç·¨é›†',
        noGroup:'ã‚°ãƒ«ãƒ¼ãƒ—ãªã—',
        group:'ã‚°ãƒ«ãƒ¼ãƒ—',
        alertGroupName:'ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
        confirmDeleteGroup:'ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
        selectAll:'å…¨é¸æŠ',
        deselectAll:'å…¨è§£é™¤',
        bulkGroup:'é¸æŠä¸­ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–',
        selectGroup:'ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠ',
        noItemSelected:'å•†å“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“',
        noGroupSelected:'ã‚°ãƒ«ãƒ¼ãƒ—ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“',
        checkQty:'ãƒã‚§ãƒƒã‚¯æ•°é‡',
        partialCheck:'éƒ¨åˆ†ãƒã‚§ãƒƒã‚¯',
        fullCheck:'å…¨æ•°  ã‚§ãƒƒã‚¯',
        close:'é–‰ã˜ã‚‹',
        foundItem:'è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ',
        qtyRemaining:'æ®‹ã‚Š',
        invalidQty:'æ•°é‡ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“',
        confirmResetAll:'ãƒã‚§ãƒƒã‚¯å‰ãƒªã‚¹ãƒˆã€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ãƒªã‚¹ãƒˆã‚’å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“'
      },
      en: {
        passwordTitle:'Enter Password',
        passwordPlaceholder:'Enter password',
        loginBtn:'Login',
        loginTitle:'Login',
        userIdPlaceholder:'Enter User ID',
        logoutBtn:'Logout',
        currentUser:'User:',
        precheckTitle:'Pre-Check List', 
        checklistTitle:'Checklist', 
        checkedTitle:'Checked Items',
        groupsTitle:'Group Management',
        wrongPass:'Incorrect password', 
        add:'Add', 
        ocr:'Add via OCR', 
        confirm:'Confirm to Checklist', 
        reset:'Reset', 
        del:'Delete', 
        check:'âœ”',
        codePlaceholder:'8-digit code',
        qtyLabel:'Qty',
        memoPlaceholder:'Memo',
        searchPlaceholder:'Search code',
        searchBtn:'Search',
        notFound:'Code not found',
        navPrecheck:'Pre-Check',
        navChecklist:'Checklist',
        navChecked:'Checked',
        navGroups:'Groups',
        alertId:'Please enter ID',
        alertCode:'Please enter 8-digit code',
        confirmAdd:' codes found. Add them?',
        noCode:'No codes detected',
        confirmReset:'Really reset?',
        confirmChecklistReset:'Reset checklist?',
        groupNamePlaceholder:'Group name',
        addGroup:'Add Group',
        editGroup:'Edit',
        noGroup:'No Group',
        group:'Group',
        alertGroupName:'Please enter group name',
        confirmDeleteGroup:'Delete this group?',
        selectAll:'Select All',
        deselectAll:'Deselect All',
        bulkGroup:'Group Selected',
        selectGroup:'Select Group',
        noItemSelected:'No items selected',
        noGroupSelected:'No group selected',
        checkQty:'Check Qty',
        partialCheck:'Partial Check',
        fullCheck:'Full Check',
        close:'Close',
        foundItem:'Found',
        qtyRemaining:'remaining',
        invalidQty:'Invalid quantity',
        confirmResetAll:'Reset all Pre-Check, Checklist, and Checked items? This action cannot be undone'
      }
    };

    const pages = ['page-precheck','page-checklist','page-checked','page-groups'];

    function showPage(id){
      pages.forEach(p=>document.getElementById(p).classList.add('hidden'));
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚‚éè¡¨ç¤º
      document.getElementById('page-password').classList.add('hidden');
      document.getElementById('page-login').classList.add('hidden');
      
      document.getElementById(id).classList.remove('hidden');
      const key = id.replace('page-', '') + 'Title';
      document.getElementById('title').textContent = texts[lang][key] || '';
      document.querySelectorAll('nav button').forEach(btn=>btn.classList.remove('active'));
      if (id==='page-precheck') document.getElementById('navPrecheck').classList.add('active');
      if (id==='page-checklist') document.getElementById('navChecklist').classList.add('active');
      if (id==='page-checked') document.getElementById('navChecked').classList.add('active');
      if (id==='page-groups') document.getElementById('navGroups').classList.add('active');
    }

    function applyLang(){
      document.getElementById('passwordInput').placeholder = texts[lang].passwordPlaceholder;
      document.getElementById('passwordSubmit').textContent = texts[lang].loginBtn;
      document.getElementById('passwordError').textContent = texts[lang].wrongPass;
      document.getElementById('userIdInput').placeholder = texts[lang].userIdPlaceholder;
      document.getElementById('loginSubmit').textContent = texts[lang].loginBtn;
      document.getElementById('logoutBtn').textContent = texts[lang].logoutBtn;
      if(currentUserId) {
        document.getElementById('userDisplay').textContent = `${texts[lang].currentUser} ${currentUserId}`;
      }
      document.getElementById('productCodeInput').placeholder = texts[lang].codePlaceholder;
      document.getElementById('productMemoInput').placeholder = texts[lang].memoPlaceholder;
      document.getElementById('addProductBtn').textContent = texts[lang].add;
      document.getElementById('ocrBtn').textContent = texts[lang].ocr;
      document.getElementById('precheckConfirm').textContent = texts[lang].confirm;
      document.getElementById('precheckReset').textContent = texts[lang].reset;
      document.getElementById('searchCodeInput').placeholder = texts[lang].searchPlaceholder;
      document.getElementById('searchBtn').textContent = texts[lang].searchBtn;
      document.getElementById('checklistReset').textContent = texts[lang].reset;
      document.getElementById('navPrecheck').textContent = texts[lang].navPrecheck;
      document.getElementById('navChecklist').textContent = texts[lang].navChecklist;
      document.getElementById('navChecked').textContent = texts[lang].navChecked;
      document.getElementById('navGroups').textContent = texts[lang].navGroups;
      document.getElementById('groupNameInput').placeholder = texts[lang].groupNamePlaceholder;
      document.getElementById('addGroupBtn').textContent = texts[lang].addGroup;
      document.getElementById('selectAllBtn').textContent = texts[lang].selectAll;
      document.getElementById('deselectAllBtn').textContent = texts[lang].deselectAll;
      document.getElementById('bulkGroupBtn').textContent = texts[lang].bulkGroup;
      // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã‚‚æ›´æ–°
      const currentPage = pages.find(p => !document.getElementById(p).classList.contains('hidden'));
      if(currentPage) {
        const key = currentPage.replace('page-', '') + 'Title';
        document.getElementById('title').textContent = texts[lang][key] || '';
      }
      // ãƒªã‚¹ãƒˆã‚’å†æç”»
      renderPrecheck();
      renderChecklist();
      renderChecked();
      renderGroups();
      updateBulkGroupSelect();
    }

     async function copyToClipboard(text, button) {
      try {
        await navigator.clipboard.writeText(text);
        const originalHTML = button.innerHTML;
        button.innerHTML = 'âœ“';
        button.classList.add('copied');
        setTimeout(() => {
          button.innerHTML = originalHTML;
          button.classList.remove('copied');
        }, 1500);
      } catch (err) {
        console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
      }
    }
    document.getElementById('langBtn').addEventListener('click',()=>{
      // ã‚¯ãƒªãƒƒã‚¯ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
      langBtnClickCount++;

      // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
      if(langBtnClickTimer) {
        clearTimeout(langBtnClickTimer);
      }

      // 3ç§’å¾Œã«ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
      langBtnClickTimer = setTimeout(() => {
        langBtnClickCount = 0;
      }, 3000);

      // 5å›ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ
      if(langBtnClickCount >= 5) {
        langBtnClickCount = 0;
        clearTimeout(langBtnClickTimer);

        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
        if(confirm(texts[lang].confirmResetAll)){
          resetAllLists();
        }
        return;
      }

      // é€šå¸¸ã®è¨€èªåˆ‡ã‚Šæ›¿ãˆå‡¦ç†
      lang=(lang==='ja')?'en':'ja';
      applyLang();
    });

    // Password
    document.getElementById('passwordSubmit').onclick=()=>{
      const val=document.getElementById('passwordInput').value;
      if(val===PASSWORD){ showPage('page-login'); }
      else{ const err=document.getElementById('passwordError'); err.style.display='block'; setTimeout(()=>err.style.display='none',2000); }
    };

    // Login
    let currentUserId = null;

document.getElementById('loginSubmit').onclick=()=>{
  const id=document.getElementById('userIdInput').value.trim();
  if(!id) return alert(texts[lang].alertId);

  // å‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
  if(currentUserId) {
    saveData();
  }

  // ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¦ã‹ã‚‰æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
  precheckList = [];
  checklist = [];
  checkedList = [];
  groups = [];

  currentUserId = id;
  localStorage.setItem('indent:user', id);
  loadUserData(); // æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿

  // UIã‚’æ›´æ–°ã—ã¦ã‹ã‚‰å†æç”»
  document.getElementById('userDisplay').textContent = `${texts[lang].currentUser} ${currentUserId}`;
  document.getElementById('userDisplay').style.display = 'block';
  document.getElementById('logoutBtn').style.display = 'block';
  
  // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã å¾Œã«ç”»é¢ã‚’å†æç”»
  renderPrecheck();
  renderChecklist();
  renderChecked();
  renderGroups();
  updateBulkGroupSelect();
  
  showPage('page-precheck');
};

    document.getElementById('logoutBtn').onclick=()=>{
      // ğŸ”¹ Firebaseãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
      if(currentUserId) {
        database.ref(`users/${currentUserId}`).off();
      }
      
      localStorage.removeItem('indent:user');
      currentUserId = null;
      precheckList = [];
      checklist = [];
      checkedList = [];
      groups = [];
      document.getElementById('userDisplay').style.display = 'none';
      document.getElementById('logoutBtn').style.display = 'none';
      document.getElementById('userIdInput').value = '';
      document.getElementById('page-password').classList.remove('hidden');
      document.getElementById('page-login').classList.add('hidden');
      pages.forEach(p=>document.getElementById(p).classList.add('hidden'));
      document.getElementById('title').textContent = texts[lang].passwordTitle;
    };
    let precheckList = [];
    let checklist = [];
    let checkedList = [];
    let groups = [];

    function getUserKey(key){
      return `indent:${currentUserId}:${key}`;
    }

    // ğŸ”¹ Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸï¼‰
    function loadUserData(){
      if(!currentUserId) return;
      
      const userRef = database.ref(`users/${currentUserId}`);
      
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      userRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if(data) {
          precheckList = data.precheck || [];
          checklist = data.checklist || [];
          checkedList = data.checked || [];
          groups = data.groups || [];
          
          // ç”»é¢ã‚’æ›´æ–°
          renderPrecheck();
          renderChecklist();
          renderChecked();
          renderGroups();
          updateBulkGroupSelect();
        }
      });
    }

    // ğŸ”¹ Firebaseã«ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    function saveData(){
      if(!currentUserId) return;
      
      database.ref(`users/${currentUserId}`).set({
        precheck: precheckList,
        checklist: checklist,
        checked: checkedList,
        groups: groups,
        lastUpdated: Date.now()
      }).catch(error => {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      });
    }

    function resetAllLists(){
      precheckList = [];
      checklist = [];
      checkedList = [];
      saveData();
      renderPrecheck();
      renderChecklist();
      renderChecked();
    }

    function renderPrecheck(){
      const el=document.getElementById('precheckList'); el.innerHTML='';
      precheckList.forEach((item)=>{
        const div=document.createElement('div');
        div.className='list-item';
        div.dataset.itemId = item.id;
        let groupOptions = `<option value="">${texts[lang].noGroup}</option>`;
        groups.forEach(g => {
          groupOptions += `<option value="${g.id}" ${item.groupId===g.id?'selected':''}>${g.name}</option>`;
        });
        div.innerHTML=`
          <input type="checkbox" class="item-checkbox" data-id="${item.id}" ${item.selected?'checked':''} style="margin-right:8px;">
          <div class="item-left">
          <div class="code-with-image">
  <span>${item.code}</span>
  <button class="copy-btn" data-code="${item.code}" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button>
  <button class="copy-btn ikea-img-btn" data-code="${item.code}" title="ç”»åƒè¡¨ç¤º">ğŸ“·</button>
</div>

            <div>
              ${texts[lang].qtyLabel}: <input type='number' class='small-input qty' data-id='${item.id}' value='${item.qty}' min='1'>
              <input type='text' class='small-input memo' data-id='${item.id}' value='${item.memo||''}' placeholder='${texts[lang].memoPlaceholder}'>
            </div>
            <div>
              ${texts[lang].group}: <select class='small-select group-select' data-id='${item.id}'>${groupOptions}</select>
            </div>
          </div>
          <button data-id='${item.id}' class='small-btn removeBtn'>${texts[lang].del}</button>`;
        el.appendChild(div);
      });
      document.querySelectorAll('#precheckList .copy-btn').forEach(btn => {
  btn.onclick = (e) => {
    e.stopPropagation();
    copyToClipboard(e.target.dataset.code, e.target);
  };
});

// ğŸ“· IKEAç”»åƒãƒœã‚¿ãƒ³æŠ¼ä¸‹å‡¦ç† â† ã“ã“ã‚’è¿½åŠ ï¼
      document.querySelectorAll('#precheckList .copy-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          copyToClipboard(e.target.dataset.code, e.target);
        };
      });

      // ğŸ“· IKEAç”»åƒãƒœã‚¿ãƒ³æŠ¼ä¸‹å‡¦ç†ï¼ˆãƒã‚§ãƒƒã‚¯å‰ãƒªã‚¹ãƒˆï¼‰
      document.querySelectorAll('#precheckList .ikea-img-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const code = e.target.dataset.code;
          fetchIkeaProductImage(code);
        };
      });
    } // â† renderPrecheck() ã®çµ‚ã‚ã‚Šã‚’ã“ã“ã§é–‰ã˜ã‚‹ï¼

    function findItemById(list, id){
      return list.find(item => item.id === id);
    }

   function processPartialCheck(indices, checkQty, totalQty) {
  if (checkQty <= 0 || checkQty > totalQty) {
    alert(texts[lang].invalidQty);
    return false;
  }

  let remainingCheckQty = checkQty;
  const sortedIndices = [...indices].sort((a, b) => b - a);

  // ãƒã‚§ãƒƒã‚¯å‡¦ç†ï¼ˆæ•°é‡ã‚’åˆ†å‰²ã—ã¦ç§»å‹•ï¼‰
  for (let i of sortedIndices) {
    if (remainingCheckQty <= 0) break;

    const item = checklist[i];
    if (!item) continue;

    if (item.qty <= remainingCheckQty) {
      checkedList.push({ ...item });
      remainingCheckQty -= item.qty;
      checklist.splice(i, 1);
    } else {
      checkedList.push({
        code: item.code,
        qty: remainingCheckQty,
        memo: item.memo,
        groupId: item.groupId
      });
      item.qty -= remainingCheckQty;
      remainingCheckQty = 0;
    }
  }

  saveData();

  // âœ… å†æç”»ã¯ä¸€å‘¼å¸ãŠã„ã¦å®‰å…¨ã«è¡Œã†
  setTimeout(() => {
    renderChecklist();
    renderChecked();
  }, 10);

  return true;
}

    function createInlineCheckBox(code, totalQty, indices, firstIndex, placeholder, onClose){
      document.querySelectorAll('[id^="inline-box-"]').forEach(box => box.innerHTML = '');

      const inlineBox = document.createElement('div');
      inlineBox.className = 'inline-check-box';
      inlineBox.innerHTML = `
        <span style="font-weight:bold;">${code} (${texts[lang].qtyRemaining}: ${totalQty})</span>
        <span>${texts[lang].checkQty}:</span>
        <input type="number" id="inline-qty-${firstIndex}" min="1" max="${totalQty}" value="${totalQty}" />
        <button class="small-btn inline-partial-check" data-indices="${indices.join(',')}" style="font-size:14px;padding:6px 10px;">${texts[lang].partialCheck}</button>
        <button class="inline-close" data-index="${firstIndex}" style="background:#999;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:14px;">${texts[lang].close}</button>
      `;
      placeholder.appendChild(inlineBox);
      placeholder.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      document.querySelector('.inline-partial-check').onclick = () => {
        const checkQty = Number(document.getElementById(`inline-qty-${firstIndex}`).value);
        processPartialCheck(indices, checkQty, totalQty);
      };

      document.querySelector('.inline-close').onclick = () => {
        placeholder.innerHTML = '';
        if(onClose) onClose();
      };
    }

    function renderChecklist(){
      const el=document.getElementById('checklist'); el.innerHTML='';
      
      // åŒã˜ã‚³ãƒ¼ãƒ‰+ã‚°ãƒ«ãƒ¼ãƒ—ã®å•†å“ã‚’é›†ç´„
      const aggregated = {};
      checklist.forEach((item, i) => {
        const key = `${item.code}_${item.groupId || 'nogroup'}`;
        if(aggregated[key]) {
          aggregated[key].qty += item.qty;
          aggregated[key].indices.push(i);
          // ãƒ¡ãƒ¢ã‚’çµ±åˆï¼ˆSet ã§é‡è¤‡ã‚’é˜²ãï¼‰
          if(item.memo) {
            const memos = aggregated[key].memo ? aggregated[key].memo.split(', ') : [];
            if(!memos.includes(item.memo)) {
              memos.push(item.memo);
              aggregated[key].memo = memos.join(', ');
            }
          }
        } else {
          aggregated[key] = {
            code: item.code,
            qty: item.qty,
            memo: item.memo || '',
            groupId: item.groupId,
            indices: [i]
          };
        }
      });
      
      // é›†ç´„ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ã«åˆ†é¡
      const groupedItems = {};
      const noGroupItems = [];
      
      Object.values(aggregated).forEach(item => {
        if (item.groupId) {
          if (!groupedItems[item.groupId]) {
            groupedItems[item.groupId] = [];
          }
          groupedItems[item.groupId].push(item);
        } else {
          noGroupItems.push(item);
        }
      });
      
      // ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«è¡¨ç¤º
      groups.forEach(group => {
        if (groupedItems[group.id] && groupedItems[group.id].length > 0) {
          const header = document.createElement('div');
          header.className = 'group-header';
          header.style.borderLeftColor = group.color;
          header.textContent = group.name;
          el.appendChild(header);
          
          groupedItems[group.id].forEach(item => {
            const firstIndex = item.indices[0];
            const div = document.createElement('div');
            div.className = 'list-item';
            div.id = `checklist-item-${firstIndex}`;
            div.innerHTML = `
              <div class="item-left">
                <span class="code-clickable" data-indices="${item.indices.join(',')}" style="cursor:pointer;text-decoration:underline;">${item.code}</span> Ã—${item.qty}
                ${item.memo ? `<span class="memo">${item.memo}</span>` : ''}
              </div>
              <button data-indices='${item.indices.join(',')}' class='small-btn checkBtn'>${texts[lang].check}</button>`;
            el.appendChild(div);
            
            // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ•°é‡æŒ‡å®šãƒœãƒƒã‚¯ã‚¹ã‚’æŒ¿å…¥ã™ã‚‹å ´æ‰€
            const placeholder = document.createElement('div');
            placeholder.id = `inline-box-${firstIndex}`;
            el.appendChild(placeholder);
          });
        }
      });
      
      // ã‚°ãƒ«ãƒ¼ãƒ—ãªã—ã®é …ç›®ã‚’è¡¨ç¤º
      if (noGroupItems.length > 0) {
        const header = document.createElement('div');
        header.className = 'group-header';
        header.style.borderLeftColor = '#999';
        header.textContent = texts[lang].noGroup;
        el.appendChild(header);
        
       noGroupItems.forEach(item => {
  const firstIndex = item.indices[0];
  const div = document.createElement('div');
  div.className = 'list-item';
  div.id = `checklist-item-${firstIndex}`;
  div.innerHTML = `
      <div class="item-left">
        <div class="code-with-image">
          <span class="code-clickable" data-indices="${item.indices.join(',')}" style="cursor:pointer;text-decoration:underline;">${item.code}</span>
          <button class="copy-btn" data-code="${item.code}" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button>
          <button class="copy-btn ikea-img-btn" data-code="${item.code}" title="ç”»åƒè¡¨ç¤º">ğŸ“·</button>
        </div>
        <span>Ã—${item.qty}</span>
      ${item.memo ? `<span class="memo">${item.memo}</span>` : ''}
    </div>
    <button data-indices='${item.indices.join(',')}' class='small-btn checkBtn'>${texts[lang].check}</button>`;
  el.appendChild(div);

          
          // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ•°é‡æŒ‡å®šãƒœãƒƒã‚¯ã‚¹ã‚’æŒ¿å…¥ã™ã‚‹å ´æ‰€
          const placeholder = document.createElement('div');
          placeholder.id = `inline-box-${firstIndex}`;
          el.appendChild(placeholder);
        });
      }
      
      document.querySelectorAll('.checkBtn').forEach(btn=>btn.onclick=e=>{
        const indices = e.target.dataset.indices.split(',').map(Number).sort((a,b) => b-a);
        // è©²å½“ã™ã‚‹å…¨ã¦ã®å•†å“ã‚’ä¸¸ã”ã¨ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã«ç§»å‹•ï¼ˆå¾Œã‚ã‹ã‚‰å‰Šé™¤ã€ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆï¼‰
        indices.forEach(i => {
          checkedList.push({...checklist[i]});
          checklist.splice(i,1);
        });
        saveData(); renderChecklist(); renderChecked();
      });
      
      // ã‚³ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ•°é‡æŒ‡å®šãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
      document.querySelectorAll('.code-clickable').forEach(span=>span.onclick=e=>{
        const indices = e.target.dataset.indices.split(',').map(Number);
        const firstIndex = indices[0];

        // é›†ç´„ã•ã‚ŒãŸæ•°é‡ã‚’è¨ˆç®—
        let totalQty = 0;
        let aggregatedItem = {code: '', memo: '', groupId: null};
        indices.forEach(i => {
          totalQty += checklist[i].qty;
          aggregatedItem = checklist[i];
        });

        const placeholder = document.getElementById(`inline-box-${firstIndex}`);

        // æ—¢ã«é–‹ã„ã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹
        if(placeholder.innerHTML !== '') {
          placeholder.innerHTML = '';
          return;
        }

        createInlineCheckBox(aggregatedItem.code, totalQty, indices, firstIndex, placeholder);
      });
    // ğŸ“‹ ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã®å‡¦ç†
      document.querySelectorAll('#checklist .copy-btn:not(.ikea-img-btn)').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          copyToClipboard(e.target.dataset.code, e.target);
        };
      });

      // ğŸ“· IKEAç”»åƒãƒœã‚¿ãƒ³ã®å‡¦ç†
      document.querySelectorAll('#checklist .ikea-img-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const code = e.target.dataset.code;
          fetchIkeaProductImage(code);
        };
      });
    }

    function renderChecked(){
      const el=document.getElementById('checkedList'); el.innerHTML='';
      const grouped = {};
      checkedList.forEach(it=>{
        if(grouped[it.code]) {
          grouped[it.code].qty+=it.qty;
          // ãƒ¡ãƒ¢ã‚’çµ±åˆï¼ˆSet ã§é‡è¤‡ã‚’é˜²ãï¼‰
          if(it.memo) {
            const memos = grouped[it.code].memo ? grouped[it.code].memo.split(', ') : [];
            if(!memos.includes(it.memo)) {
              memos.push(it.memo);
              grouped[it.code].memo = memos.join(', ');
            }
          }
        } else {
          grouped[it.code]={...it};
        }
      });
      
      const groupedArray = Object.values(grouped);
      groupedArray.forEach((it, i)=>{
        const div=document.createElement('div');
        div.className='list-item';
        div.innerHTML=`
          <div class="item-left">
            <span>${it.code} Ã—${it.qty}</span>
            ${it.memo?`<span class="memo">${it.memo}</span>`:''}
          </div>
          <button data-i='${i}' class='small-btn removeCheckedBtn'>${texts[lang].del}</button>`;
        el.appendChild(div);
      });
      document.querySelectorAll('.removeCheckedBtn').forEach(btn=>btn.onclick=e=>{
        const code = groupedArray[e.target.dataset.i].code;
        checkedList = checkedList.filter(it => it.code !== code);
        saveData(); renderChecked();
      });
       
    }

    function renderGroups(){
      const el=document.getElementById('groupsList'); el.innerHTML='';
      groups.forEach((group,i)=>{
        const div=document.createElement('div');
        div.className='group-item';
        div.innerHTML=`
          <div style="display:flex;align-items:center;gap:10px;flex:1;">
            <div class="group-color" style="background:${group.color}"></div>
            <input type="text" class="small-input group-name-input" data-i="${i}" value="${group.name}" style="flex:1;">
            <input type="color" class="group-color-input" data-i="${i}" value="${group.color}">
          </div>
          <button data-i='${i}' class='small-btn delGroupBtn'>${texts[lang].del}</button>`;
        el.appendChild(div);
      });
      document.querySelectorAll('.group-name-input').forEach(input=>input.onchange=e=>{
        groups[e.target.dataset.i].name=e.target.value; saveData(); renderPrecheck(); renderChecklist();
      });
      document.querySelectorAll('.group-color-input').forEach(input=>input.onchange=e=>{
        groups[e.target.dataset.i].color=e.target.value; saveData(); renderChecklist();
      });
      document.querySelectorAll('.delGroupBtn').forEach(btn=>btn.onclick=e=>{
        if(confirm(texts[lang].confirmDeleteGroup)){
          const groupId = groups[e.target.dataset.i].id;
          groups.splice(e.target.dataset.i,1);
          // ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å•†å“ã‹ã‚‰ã‚°ãƒ«ãƒ¼ãƒ—IDã‚’å‰Šé™¤
          precheckList.forEach(item => {
            if(item.groupId === groupId) item.groupId = null;
          });
          checklist.forEach(item => {
            if(item.groupId === groupId) item.groupId = null;
          });
          checkedList.forEach(item => {
            if(item.groupId === groupId) item.groupId = null;
          });
          saveData(); renderGroups(); renderPrecheck(); renderChecklist();
        }
      });
    }

    function updateBulkGroupSelect(){
      const select = document.getElementById('bulkGroupSelect');
      select.innerHTML = `<option value="">${texts[lang].selectGroup}</option>`;
      groups.forEach(g => {
        select.innerHTML += `<option value="${g.id}">${g.name}</option>`;
      });
    }

    document.getElementById('selectAllBtn').onclick = () => {
      precheckList.forEach(item => item.selected = true);
      renderPrecheck();
    };

    document.getElementById('deselectAllBtn').onclick = () => {
      precheckList.forEach(item => item.selected = false);
      renderPrecheck();
    };

    document.getElementById('bulkGroupBtn').onclick = () => {
      const selectedGroupId = document.getElementById('bulkGroupSelect').value;
      if(!selectedGroupId) return alert(texts[lang].noGroupSelected);
      
      const selectedItems = precheckList.filter(item => item.selected);
      if(selectedItems.length === 0) return alert(texts[lang].noItemSelected);
      
      precheckList.forEach(item => {
        if(item.selected) {
          item.groupId = selectedGroupId;
          item.selected = false;
        }
      });
      
      saveData();
      renderPrecheck();
    };

// ğŸ”¹ IKEAå•†å“æƒ…å ±ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤ºã™ã‚‹é–¢æ•°
function fetchIkeaProductImage(code) {
  // ãƒ‰ãƒƒãƒˆã‚„ã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»ã—ã¦8æ¡ã®æ•°å­—ã®ã¿ã«ã™ã‚‹
  const cleanCode = code.replace(/[.\s]/g, '');
  
  // IKEAã®å•†å“ç•ªå·å½¢å¼: æœ€åˆã®3æ¡.æ¬¡ã®3æ¡.æœ€å¾Œã®2æ¡
  let formattedCode = cleanCode;
  if (cleanCode.length === 8) {
    formattedCode = `${cleanCode.slice(0, 3)}.${cleanCode.slice(3, 6)}.${cleanCode.slice(6, 8)}`;
  }

  const existing = document.getElementById('ikeaModal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'ikeaModal';
  modal.style.cssText = `
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  `;

  modal.innerHTML = `
    <div style="
      background:#fff;
      padding:16px;
      border-radius:10px;
      box-shadow:0 4px 8px rgba(0,0,0,0.2);
      text-align:center;
      max-width:360px;
      max-height:80vh;
      overflow-y:auto;
    ">
      <h3 style="margin:0 0 12px 0;font-size:16px;color:#333;">IKEAå•†å“: ${formattedCode}</h3>
      
      <div style="margin-bottom:12px;">
        <a href="https://www.ikea.com/jp/ja/search/?q=${cleanCode}" target="_blank"
           style="display:inline-block;padding:10px 20px;background:#0058a3;color:#fff;text-decoration:none;border-radius:5px;font-size:14px;font-weight:500;">
           ğŸ” IKEAå…¬å¼ã§æ¤œç´¢
        </a>
      </div>

      <div style="margin-bottom:12px;">
        <a href="https://www.google.com/search?q=IKEA+${formattedCode}+${cleanCode}&tbm=isch" target="_blank"
           style="display:inline-block;padding:10px 20px;background:#4285f4;color:#fff;text-decoration:none;border-radius:5px;font-size:14px;font-weight:500;">
           ğŸ–¼ï¸ Googleç”»åƒæ¤œç´¢
        </a>
      </div>

      <div style="background:#f5f7fa;padding:12px;border-radius:5px;margin-bottom:12px;">
        <p style="margin:0;font-size:13px;color:#555;line-height:1.5;">
          <strong>å•†å“ç•ªå·:</strong><br>
          <span style="font-family:monospace;font-size:14px;color:#0058a3;">${formattedCode}</span>
          <button class="copy-code-btn" style="margin-left:8px;padding:4px 8px;border:none;background:#3498db;color:#fff;border-radius:3px;cursor:pointer;font-size:12px;">
            ğŸ“‹ ã‚³ãƒ”ãƒ¼
          </button>
        </p>
      </div>

      <div style="font-size:12px;color:#777;margin-bottom:12px;line-height:1.4;">
        ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰å…¬å¼ã‚µã‚¤ãƒˆã‚„ç”»åƒæ¤œç´¢ã§å•†å“ã‚’ç¢ºèªã§ãã¾ã™
      </div>

      <button id="ikeaCloseBtn" style="
        width:100%;
        padding:10px 16px;
        border:none;
        background:#95a5a6;
        color:#fff;
        border-radius:5px;
        cursor:pointer;
        font-size:14px;
        font-weight:500;
      ">é–‰ã˜ã‚‹</button>
    </div>
  `;

  document.body.appendChild(modal);
  
  // ã‚³ãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
  modal.querySelector('.copy-code-btn').onclick = async (e) => {
    e.stopPropagation();
    try {
      await navigator.clipboard.writeText(formattedCode);
      const btn = e.target;
      const originalText = btn.textContent;
      btn.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼æ¸ˆã¿';
      btn.style.background = '#27ae60';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '#3498db';
      }, 1500);
    } catch (err) {
      console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
    }
  };
  
  document.getElementById('ikeaCloseBtn').onclick = () => modal.remove();
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}
    document.getElementById('addGroupBtn').onclick=()=>{
      const name=document.getElementById('groupNameInput').value.trim();
      const color=document.getElementById('groupColorInput').value;
      if(!name) return alert(texts[lang].alertGroupName);
      groups.push({id:Date.now().toString(),name,color}); 
      saveData(); renderGroups(); renderPrecheck(); updateBulkGroupSelect();
      document.getElementById('groupNameInput').value='';
    };

   document.getElementById('addProductBtn').onclick=()=>{
  const code=document.getElementById('productCodeInput').value.trim();
  // âœ… ãƒ‰ãƒƒãƒˆä»˜ãï¼ˆä¾‹: 204.393.92ï¼‰ã‚„8æ¡æ•°å­—ã‚’è¨±å¯
 // if(/^(?:\d[.\s]?){8}$/.test(code)) fetchIkeaProductImage(code);
  
  const qty=Number(document.getElementById('productQtyInput').value)||1;
  const memo=document.getElementById('productMemoInput').value.trim();

  // âœ… åŒã˜ã8æ¡ or ãƒ‰ãƒƒãƒˆå¯¾å¿œ
  if(!/^(?:\d[.\s]?){8}$/.test(code)) return alert(texts[lang].alertCode);
  if(qty <= 0) return alert(texts[lang].invalidQty);

      precheckList.push({id:Date.now().toString(),code,qty,memo,selected:false}); saveData(); renderPrecheck();
      document.getElementById('productCodeInput').value=''; document.getElementById('productMemoInput').value='';
    };

    document.getElementById('ocrBtn').onclick=()=>{
      const input=document.createElement('input'); input.type='file'; input.accept='image/*'; input.capture='environment';
      input.onchange=async(e)=>{
        const file=e.target.files[0];
        if(!file) return;
        const result=await Tesseract.recognize(file,'eng',{ tessedit_char_whitelist:'0123456789' });
      // âœ… 8æ¡ or ãƒ‰ãƒƒãƒˆä»˜ãæ•°å­—ã«ã‚‚å¯¾å¿œ
const codes=result.data.text.match(/(?:\d[.\s]?){8}/g)||[];

        const uniqueCodes = [...new Set(codes)];
        if(uniqueCodes.length){
          if(confirm(`${uniqueCodes.length}${texts[lang].confirmAdd}`)){
            uniqueCodes.forEach(c=>precheckList.push({id:Date.now().toString()+Math.random(),code:c,qty:1,memo:'',selected:false}));
            saveData(); renderPrecheck();
          }
        }else{
          alert(texts[lang].noCode);
        }
      };
      input.click();
    };

    document.getElementById('precheckConfirm').onclick=()=>{ checklist.push(...precheckList); precheckList=[]; saveData(); renderPrecheck(); renderChecklist(); showPage('page-checklist'); };

    document.getElementById('searchBtn').onclick=()=>{
      const searchCode = document.getElementById('searchCodeInput').value.trim();
      if(!searchCode) return;
      
      // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‹ã‚‰æ¤œç´¢ï¼ˆåŒã˜ã‚³ãƒ¼ãƒ‰+ã‚°ãƒ«ãƒ¼ãƒ—ã®çµ„ã¿åˆã‚ã›ã‚’å…¨ã¦å–å¾—ï¼‰
      const matches = [];
      checklist.forEach((item, i) => {
        if(item.code === searchCode) {
          const key = `${item.code}_${item.groupId || 'nogroup'}`;
          let match = matches.find(m => m.key === key);
          if(!match) {
            match = {key, indices: [], totalQty: 0, item: item};
            matches.push(match);
          }
          match.indices.push(i);
          match.totalQty += item.qty;
        }
      });
      
      if(matches.length > 0) {
        // æœ€åˆã®ãƒãƒƒãƒã‚’è¡¨ç¤ºï¼ˆè¤‡æ•°ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¾ãŸãŒã‚‹å ´åˆã¯æœ€åˆã®ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰
        const firstMatch = matches[0];
        const firstIndex = firstMatch.indices[0];
        const placeholder = document.getElementById(`inline-box-${firstIndex}`);
        
        // ä»–ã®é–‹ã„ã¦ã„ã‚‹ãƒœãƒƒã‚¯ã‚¹ã‚’å…¨ã¦é–‰ã˜ã‚‹
        document.querySelectorAll('[id^="inline-box-"]').forEach(box => box.innerHTML = '');
        
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
        document.querySelectorAll('.list-item').forEach(el => {
          el.style.backgroundColor = '';
          el.style.border = '1px solid #e1e8ed';
        });

        // è¦‹ã¤ã‹ã£ãŸé …ç›®ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        const element = document.getElementById(`checklist-item-${firstIndex}`);
        if(element) {
          element.style.backgroundColor = '#fff3cd';
          element.style.border = '2px solid #ffc107';
        }

        // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ•°é‡æŒ‡å®šãƒœãƒƒã‚¯ã‚¹ã‚’è‡ªå‹•è¡¨ç¤º
        createInlineCheckBox(firstMatch.item.code, firstMatch.totalQty, firstMatch.indices, firstIndex, placeholder, () => {
          element.style.backgroundColor = '';
          element.style.border = '1px solid #e1e8ed';
        });
        
        document.getElementById('searchCodeInput').value = '';
      } else {
        alert(texts[lang].notFound);
      }
    };

    // Enterã‚­ãƒ¼ã§ã‚‚æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«
    document.getElementById('searchCodeInput').addEventListener('keypress', (e) => {
      if(e.key === 'Enter') {
        document.getElementById('searchBtn').click();
      }
    });

    document.getElementById('precheckReset').onclick=()=>{ if(confirm(texts[lang].confirmReset)){ precheckList=[]; saveData(); renderPrecheck(); } };
    document.getElementById('checklistReset').onclick=()=>{ if(confirm(texts[lang].confirmChecklistReset)){ checklist=[]; saveData(); renderChecklist(); } };

    document.getElementById('navPrecheck').onclick = () => showPage('page-precheck');
    document.getElementById('navChecklist').onclick = () => showPage('page-checklist');
    document.getElementById('navChecked').onclick = () => showPage('page-checked');
    document.getElementById('navGroups').onclick = () => showPage('page-groups');

    // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²: precheckList
    document.getElementById('precheckList').addEventListener('click', (e) => {
      const id = e.target.dataset.id;
      if(!id) return;

      if(e.target.classList.contains('removeBtn')){
        precheckList = precheckList.filter(item => item.id !== id);
        saveData();
        renderPrecheck();
      }
    });

    document.getElementById('precheckList').addEventListener('change', (e) => {
      const id = e.target.dataset.id;
      if(!id) return;

      const item = findItemById(precheckList, id);
      if(!item) return;

      if(e.target.classList.contains('item-checkbox')){
        item.selected = e.target.checked;
      } else if(e.target.classList.contains('qty')){
        const newQty = Number(e.target.value);
        if(newQty > 0 && !isNaN(newQty)){
          item.qty = newQty;
          saveData();
        } else {
          e.target.value = item.qty;
        }
      } else if(e.target.classList.contains('memo')){
        item.memo = e.target.value;
        saveData();
      } else if(e.target.classList.contains('group-select')){
        item.groupId = e.target.value || null;
        saveData();
      }
    });

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ»ãƒ­ã‚°ã‚¤ãƒ³å…¥åŠ›æ¬„ã§Enterã‚­ãƒ¼å¯¾å¿œ
    document.getElementById('passwordInput').addEventListener('keypress', (e) => {
      if(e.key === 'Enter') document.getElementById('passwordSubmit').click();
    });

    document.getElementById('userIdInput').addEventListener('keypress', (e) => {
      if(e.key === 'Enter') document.getElementById('loginSubmit').click();
    });

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‰å›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å¾©å…ƒ
    window.addEventListener('DOMContentLoaded', () => {
      const savedUser = localStorage.getItem('indent:user');
      if (savedUser) {
        currentUserId = savedUser;
        loadUserData();
        document.getElementById('userDisplay').textContent = `${texts[lang].currentUser} ${currentUserId}`;
        document.getElementById('userDisplay').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'block';
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰å†æç”»
        renderPrecheck();
        renderChecklist();
        renderChecked();
        renderGroups();
        updateBulkGroupSelect();
        
        showPage('page-precheck');
      }
      
      applyLang();
    });
  </script>
</body>
</html>


